<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - NetPulse</title>
    <link rel="stylesheet" href="./css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">✈</div>
                    <h1>NetPulse</h1>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-item active">
                        <a href="dashboard.html">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="network-devices.html">
                            <i class="fas fa-server"></i>
                            <span>Network Devices</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="environmental.html">
                            <i class="fas fa-thermometer-half"></i>
                            <span>Environmental</span>
                        </a>
                    </li>                   
                    <li class="nav-item">
                        <a href="alerts-and-incidents.html">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Alerts & Incidents</span>
                            <span class="nav-badge" id="sidebar-alert-count">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="trends-and-forecasts.html">
                            <i class="fas fa-chart-line"></i>
                            <span>Trends & Forecasts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="reports.html">
                            <i class="fas fa-file-alt"></i>
                            <span>Reports</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="settings.html">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="user-details">
                        <span class="user-name" id="sidebar-username">Loading...</span>
                        <span class="user-role" id="sidebar-userrole">Admin</span>
                    </div>
                </div>
                <a href="#" class="logout-btn" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <div class="header-title">
                    <h2>NetPulse Dashboard</h2>
                    <p>Welcome back, <span id="header-username">User</span>. Real-time system monitoring active.</p>
                </div>
                <div class="header-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search devices or alerts..." id="global-search">
                    </div>
                    <div class="notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="header-alert-count">0</span>
                    </div>
                    <div class="date-display">
                        <i class="fas fa-clock"></i>
                        <span id="current-date-time">Loading...</span>
                    </div>
                </div>
            </header>

            <!-- Real-time Status Cards -->
            <section class="kpi-section">
                <div class="kpi-card">
                    <div class="kpi-icon primary">
                        <i class="fas fa-server"></i>
                    </div>
                    <div class="kpi-content">
                        <h3>Device Status</h3>
                        <div class="kpi-value" id="kpi-devices-status">0/0 Online</div>
                        <div class="kpi-subtitle">Network Infrastructure</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon danger">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="kpi-content">
                        <h3>Active Alerts</h3>
                        <div class="kpi-value" id="kpi-active-alerts">0 Critical, 0 Warning</div>
                        <div class="kpi-subtitle">Requiring Attention</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon warning">
                        <i class="fas fa-thermometer-half"></i>
                    </div>
                    <div class="kpi-content">
                        <h3>Server Room</h3>
                        <div class="kpi-value" id="kpi-avg-temperature">0°C</div>
                        <div class="kpi-subtitle">Current Temperature</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon success">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="kpi-content">
                        <h3>System Uptime</h3>
                        <div class="kpi-value" id="kpi-ups-status">0%</div>
                        <div class="kpi-subtitle">Overall Availability</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon info">
                        <i class="fas fa-download"></i>
                    </div>
                    <div class="kpi-content">
                        <h3>Bandwidth</h3>
                        <div class="kpi-value" id="kpi-bandwidth">0 Mbps</div>
                        <div class="kpi-subtitle">Download Speed</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon info">
                        <i class="fas fa-upload"></i>
                    </div>
                    <div class="kpi-content">
                        <h3>Throughput</h3>
                        <div class="kpi-value" id="kpi-throughput">0 Mbps</div>
                        <div class="kpi-subtitle">Upload Speed</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon secondary">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div class="kpi-content">
                        <h3>Latency</h3>
                        <div class="kpi-value" id="kpi-latency">0 ms</div>
                        <div class="kpi-subtitle">Response Time</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon secondary">
                        <i class="fas fa-wave-square"></i>
                    </div>
                    <div class="kpi-content">
                        <h3>Jitter</h3>
                        <div class="kpi-value" id="kpi-jitter">0 ms</div>
                        <div class="kpi-subtitle">Network Stability</div>
                    </div>
                </div>
            </section>

            <!-- NEW: Device Grid Visualization -->
            <section class="device-grid-section">
                <div class="section-header">
                    <h3><i class="fas fa-network-wired"></i> Device Grid Overview</h3>
                    <div class="grid-controls">
                        <button class="btn small" id="refresh-devices">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <div class="view-options">
                            <button class="view-btn active" data-view="compact">Compact</button>
                            <button class="view-btn" data-view="detailed">Detailed</button>
                        </div>
                    </div>
                </div>
                
                <div class="device-grid-container">
                    <div class="device-grid" id="device-grid">
                        <div class="grid-loading">Loading devices...</div>
                    </div>
                    
                    <div class="grid-legend">
                        <div class="legend-item">
                            <span class="legend-dot online"></span>
                            <span>Online (Active)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot offline"></span>
                            <span>Offline (Inactive)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot warning"></span>
                            <span>Warning</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot critical"></span>
                            <span>Critical</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- AI Insights with Real-time Updates -->
            <section class="ai-insight">
                <div class="section-header">
                    <h3><i class="fas fa-robot"></i> AI Insights & Recommendations</h3>
                    <button class="refresh-btn" id="refresh-insights">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="insight-content">
                    <div class="insight-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="insight-text">
                        <div id="ai-insights">
                            <p>Analyzing system performance...</p>
                        </div>
                        <div class="insight-actions">
                            <button class="btn small" id="acknowledge-insight">
                                <i class="fas fa-check"></i> Acknowledge
                            </button>
                            <button class="btn small primary" id="investigate-insight">
                                <i class="fas fa-search"></i> Investigate
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Application JavaScript -->
    <script src="./js/api.js"></script>
    <script src="./js/websocket.js"></script>
    <script src="./js/charts.js"></script>
    <script src="./js/dashboard.js"></script>
    
    <!-- Initialize Application -->
    <script>
        // Device Grid Functions
        async function loadDeviceGrid() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                console.log('No token found, showing demo devices');
                showDemoDevices();
                return;
            }

            try {
                const response = await fetch('http://127.0.0.1:8000/api/devices/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    console.log('Token invalid, showing demo devices');
                    showDemoDevices();
                    return;
                }
                
                if (response.ok) {
                    const devices = await response.json();
                    renderDeviceGrid(devices);
                } else {
                    showDemoDevices();
                }
            } catch (error) {
                console.error('Error loading device grid:', error);
                showDemoDevices();
            }
        }

        function showDemoDevices() {
            const demoDevices = [
                { id: 1, name: "Core-Router-01", ip_address: "192.168.1.1", device_type: "router", is_online: true },
                { id: 2, name: "Switch-T1-A", ip_address: "192.168.1.2", device_type: "switch", is_online: true },
                { id: 3, name: "Firewall-Main", ip_address: "192.168.1.3", device_type: "firewall", is_online: false },
                { id: 4, name: "AP-Terminal-B", ip_address: "192.168.1.4", device_type: "ap", is_online: true },
                { id: 5, name: "Router-Gate-A", ip_address: "192.168.1.5", device_type: "router", is_online: true },
                { id: 6, name: "Switch-Baggage", ip_address: "192.168.1.6", device_type: "switch", is_online: false },
                { id: 7, name: "AP-Checkin", ip_address: "192.168.1.7", device_type: "ap", is_online: true },
                { id: 8, name: "Server-Room-A", ip_address: "192.168.1.8", device_type: "server", is_online: true }
            ];
            renderDeviceGrid(demoDevices);
        }

        function renderDeviceGrid(devices) {
            const grid = document.getElementById('device-grid');
            if (!devices || devices.length === 0) {
                grid.innerHTML = '<div class="grid-empty">No devices found</div>';
                return;
            }

            grid.innerHTML = devices.map(device => `
                <div class="device-item ${device.is_online ? 'online' : 'offline'}" 
                     data-device-id="${device.id}"
                     title="${device.name} - ${device.ip_address}">
                    <div class="device-icon">
                        <i class="fas fa-${getDeviceIcon(device.device_type)}"></i>
                    </div>
                    <div class="device-info">
                        <div class="device-name">${device.name}</div>
                        <div class="device-status">${device.is_online ? 'Online' : 'Offline'}</div>
                        <div class="device-ip">${device.ip_address}</div>
                    </div>
                </div>
            `).join('');
        }

        function getDeviceIcon(deviceType) {
            const icons = {
                'router': 'route',
                'switch': 'network-wired',
                'firewall': 'shield-alt',
                'ap': 'wifi',
                'server': 'server'
            };
            return icons[deviceType] || 'hdd';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Start the dashboard application
            if (typeof initializeDashboard === 'function') {
                initializeDashboard();
            }
            
            // Load device grid
            loadDeviceGrid();
            
            // Refresh devices when button clicked
            document.getElementById('refresh-devices')?.addEventListener('click', loadDeviceGrid);
            
            console.log('NetPulse Dashboard initialized successfully');
        });
    </script>
</body>
</html>